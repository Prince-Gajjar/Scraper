<!doctype html>
<html>
<head>
  <meta charset="utf-8"/>
  <meta name="viewport" content="width=device-width,initial-scale=1"/>
  <title>Multi-keyword OSM Scraper</title>
  <style>
    :root {
      --bg:#0b1220; --card:#0f1a29; --accent:#00b3ff; --muted:#8ca3b8; --text:#e6eef8;
    }
    body{background:var(--bg); color:var(--text); font-family:Inter, Arial, sans-serif; padding:32px; display:flex; justify-content:center}
    .wrap{width:100%; max-width:980px}
    .card{background:var(--card); padding:22px; border-radius:12px; box-shadow:0 6px 30px rgba(0,0,0,0.5)}
    h1{text-align:center; color:var(--accent); margin-bottom:12px}
    textarea, input[type="text"], input[type="number"]{width:100%; padding:10px; border-radius:8px; border:none; background:#12202b; color:var(--text); margin-top:8px}
    label{display:block; margin-top:10px; color:var(--muted)}
    button{background:var(--accent); color:#022; padding:10px 14px; border-radius:8px; border:none; font-weight:700; cursor:pointer; margin-top:12px}
    .flex{display:flex; gap:12px}
    .progress{height:12px; background:#102233; border-radius:8px; overflow:hidden; margin-top:12px}
    .bar{height:12px; width:0%; background:linear-gradient(90deg, #00b3ff, #008cff); transition:width 0.4s}
    .status{margin-top:10px; color:var(--muted)}
    .keyword-list{margin-top:12px; max-height:200px; overflow:auto; background:#0b141b; padding:8px; border-radius:6px}
    .kw-item{padding:6px 8px; border-radius:6px; background:#072029; margin-bottom:6px; display:flex; justify-content:space-between; align-items:center}
    a.download{display:block; margin-top:12px; text-align:center; padding:10px; background:#008cff; color:white; text-decoration:none; border-radius:8px}
    .small{font-size:13px; color:var(--muted)}
  </style>
</head>
<body>
  <div class="wrap">
    <div class="card">
      <h1>Multi-keyword OSM Scraper</h1>
      <label>Paste keywords (one per line or comma-separated). Example: <span class="small">it company, software firm, startup</span></label>
      <textarea id="keywords" rows="6" placeholder="Enter 100+ keywords here..."></textarea>

      <label>Or upload a .txt file with one keyword per line</label>
      <input type="file" id="file">

      <div class="flex">
        <div style="flex:1">
          <label>City (required)</label>
          <input id="city" type="text" placeholder="e.g., Ahmedabad">
        </div>
        <div style="width:160px">
          <label>Max results per keyword</label>
          <input id="max_per_keyword" type="number" value="50" min="1" max="500">
        </div>
      </div>

      <label><input id="try_emails" type="checkbox"> Try website email extraction (slower)</label>

      <button id="start">Start scraping</button>

      <div class="progress" style="display:none;">
        <div class="bar" id="bar"></div>
      </div>

      <div class="status" id="status"></div>

      <div class="keyword-list" id="kwlist" style="display:none"></div>

      <a id="download" class="download" style="display:none">Download CSV</a>
    </div>
  </div>

<script>
document.getElementById("start").addEventListener("click", async function(){
  const keywords = document.getElementById("keywords").value;
  const fileInput = document.getElementById("file");
  const city = document.getElementById("city").value.trim();
  const max_per_keyword = document.getElementById("max_per_keyword").value || 50;
  const try_emails = document.getElementById("try_emails").checked;

  if(!city){ alert("City is required"); return; }

  const form = new FormData();
  form.append("keywords", keywords);
  form.append("city", city);
  form.append("max_per_keyword", max_per_keyword);
  form.append("try_emails", try_emails);

  if(fileInput.files.length){
    form.append("file", fileInput.files[0]);
  }

  document.getElementById("status").textContent = "Queueing job...";
  const res = await fetch("/start", { method: "POST", body: form });
  const j = await res.json();
  if(j.error){ document.getElementById("status").textContent = "Error: " + j.error; return; }
  const job_id = j.job_id;
  document.getElementById("status").textContent = "Job started: " + job_id;
  document.querySelector(".progress").style.display = "block";
  poll(job_id);
});

async function poll(job_id){
  const bar = document.getElementById("bar");
  const status = document.getElementById("status");
  const kwlist = document.getElementById("kwlist");
  kwlist.style.display = "none";
  document.getElementById("download").style.display = "none";

  const interval = setInterval(async ()=>{
    const r = await fetch("/status/" + job_id);
    if(r.status === 404){ status.textContent = "Job not found"; clearInterval(interval); return; }
    const j = await r.json();
    const total = j.total || 0, completed = j.completed || 0;
    let pct = total ? Math.round((completed/total)*100) : 0;
    bar.style.width = pct + "%";
    status.textContent = `Status: ${j.status} — completed ${completed} of ${total}`;
    // show per-keyword list
    const kws = j.keywords || {};
    kwlist.innerHTML = "";
    for(const k of Object.keys(kws)){
      const info = kws[k];
      const el = document.createElement("div");
      el.className = "kw-item";
      el.innerHTML = `<div style="max-width:78%"><strong>${k}</strong><div class="small">${info.last_msg || ""}</div></div><div class="small">${info.count || 0}</div>`;
      kwlist.appendChild(el);
    }
    kwlist.style.display = "block";

    if(j.status === "finished"){
      clearInterval(interval);
      status.textContent = `Completed — ${completed} keywords processed. Preparing CSV...`;
      // fetch file url if any
      if(j.file){
        document.getElementById("download").href = j.file;
        document.getElementById("download").style.display = "block";
        document.getElementById("status").textContent = `Completed — CSV ready.`;
      } else {
        document.getElementById("status").textContent = `Completed — no file returned.`;
      }
    }
    if(j.status === "failed"){
      clearInterval(interval);
      status.textContent = "Job failed: " + (j.error || "unknown");
    }
  }, 2000);
}
</script>
</body>
</html>
